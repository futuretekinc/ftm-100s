/*
 * Copyright (c) 2014, Daliworks. All rights reserved.
 *
 * Reproduction and/or distribution in source and binary forms 
 * without the written consent of Daliworks, Inc. is prohibited.
 *
 */
!function(a,b){function c(b,d){var e,f;if("."!=b[0]&&"/"!=b[0])return a(b);if(d=d||"root",e=c.resolve(b),!e&&/\.json$/i.test(b))return a("./"+c.basename(b));if(f=c.cache[e],!f)throw Error('failed to require "'+b+'" from '+d);return f.exports||(f.exports={},f.call(f.exports,f,f.exports,c.relative(e))),f.exports}c.cache={},c.basename=a("path").basename,c.resolve=function(b){var d,e,f;if("."!=b[0])return a.resolve(b);for(d=[b,b+".js",b+"/index.js",b+".json",b+"/index.json"],e=0;f=d[e];e++)if(c.cache[f])return f},c.register=function(a,b){c.cache[a]=b},c.relative=function(a){function b(b){var d,e,f,g,h;if("."!=b[0])return c(b);for(d=a.split("/"),e=b.split("/"),d.pop(),f=0,g=e.length;g>f;f+=1)h=e[f],".."==h?d.pop():"."!=h&&d.push(h);return c(d.join("/"),a)}return b.resolve=c.resolve,b.cache=c.cache,b},c.register("./app.js",function(a,b,c){"use strict";var r,A,B,F,H,I,J,K,L,M,N,d=c("express"),e=c("errorhandler"),f=c("body-parser"),g=c("multer"),h=c("method-override"),i=c("serve-favicon"),j=c("morgan"),k=c("http-auth"),l=c("optimist"),m=c("async"),n=c("log4js"),o=c("os"),p=c("config"),q=c("dgram"),s=c("./routes"),t=c("./gateway"),u=c("./server"),v=c("./sensors"),w=c("./utils"),x=c("./store"),y=c("./mqtt"),z=c("./remotecontroller"),C=!1,D=l.usage("Sensorjs app",{logger:{description:"logger configuration json","default":__dirname+"/logger_cfg.json",alias:"l",string:!0},help:{description:"print help",alias:"h"}}).argv,E=process.env.NODE_ENV||"development";D.h&&(l.showHelp(),process.exit(0)),n.configure(D.logger,{reloadSecs:30}),F=n.getLogger("Main"),F.info("... Starting [%s] ...",o.hostname());try{r=c("memwatch")}catch(G){F.warn("MODULES_NOT_SUPPORTED - memwatch")}try{A=c("sensorjs/lib/sensor/driver/rgbLed")}catch(G){F.warn("MODULES_NOT_SUPPORTED - rgbLed")}H=A&&new A({device:{address:66},model:"rgbLed",id:"redLed-66"}),I=A&&new A({device:{address:68},model:"rgbLed",id:"greenLed-68"}),J=A&&new A({device:{address:69},model:"rgbLed",id:"yellowLed-69"}),setTimeout(function(){C?F.info("[init check] initialized OK"):(F.fatal("[init check] restart due to NOT being initialized within ",p.Init.timeout),z.process("restart"))},p.Init.timeout),K=d(),K.set("port",p.Gateway.port||80),K.set("views",__dirname+"/da_views"),K.set("view engine","jade"),K.set("root",__dirname),K.use(i(__dirname+"/../device_ui/app/favicon.ico")),K.use(j("dev")),K.use(f()),K.use(h()),K.get("/api/gateway/ping",function(a,b){C?b.end():b.send(503,"gateway not ready")}),K.use(k.connect(k.digest({realm:"Sensor.js"},function(a,b){b(p.Auth[a])}))),K.use(d.static(__dirname+"/../device_ui/app")),K.use(g({inMemory:!0,limits:{fields:5,files:1,fileSize:1e5}})),K.get("/api/gateway/info",s.gatewayInfo()),K.put("/api/gateway/config",s.gatewayConfig()),K.get("/api/gateway/control",s.gatewayControl()),K.get("/api/server/info",s.serverInfo()),K.get("/api/software/info",s.softwareInfo()),K.get("/api/sensor/data",s.sensorData()),K.get("/api/sensor/discover",s.sensorDiscover()),K.get("/api/sensors/:id",s.getSensorItem()),K.delete("/api/sensors/:id",s.delSensorItem()),K.post("/api/sensor/register",s.postSensorItem()),K.post("/api/certUpload",s.certUpload()),K.get("/api/interfaces",s.getInterfaces()),K.get("/api/interfaces/:id",s.getInterfaceItem()),K.get("/api/modems",s.getModems()),K.get("/api/modems/:id",s.getModemItem()),K.put("/api/modems/:id",s.putModemItem()),K.get("/api/modem/stats",s.getModemStats()),K.post("/api/chpasswd",s.chPasswd()),K.post("/api/actuator/control",s.controlActuator()),K.get("/api/sensorDrivers",s.getSensorDrivers()),"development"===E&&K.use(e({dumpExceptions:!0})),H&&H.blink(),m.series([function(a){F.info("1. get mac"),w.getId("mac",function(b,c){!b&&c?(B=c,a()):a(Error("failure to get id"))})},function(a){F.info("2. store init"),x.init(a)},function(a){var b,c;F.info("3. mqtt init"),b=p.Server.mqtt;try{c="mqtts"===b.protocol?{pfxPath:p.Gateway.CERT_FILE_PATH,caPath:p.Gateway.CA_FILE_PATH,passphrase:B,rejectUnauthorized:!0}:null,y.init(parseInt(b.port,10)||1883,b.host,B,c,x,function(b){return b&&F.error("mqtt.init() "+b.stack),a()})}catch(d){return F.error("mqtt.init exception=",d),a()}},function(a){F.info("4. server init");try{u.init(B,a)}catch(b){return a()}},function(a){F.info("5. gateway init");try{t.init(B,a)}catch(b){return a(b)}},function(a){F.info("6. sensor init");try{v.init(a)}catch(b){return a(b)}}],function(a){a?(F.fatal("init error",a),setTimeout(function(){z.process("restart")},3e4)):H&&H.on(),K.listen(K.get("port")),F.warn("... Listening on port %s ...",K.get("port")),C=!0}),w.monitor.on("mqtt",function(a){switch(a){case"active":J&&J.blink(500,5e3);break;case"connected":t.initialized&&(t.synced||t.sync(function(a){a?F.error("gateway sync at mqtt connect FAILURE",a):F.warn("gateway sync at mqtt connect SUCCESS")})),y.publish(y.topic.status,""+["on",(t.reportInterval||6e4)/1e3*1.5]),H&&H.on();break;case"closed":case"error":H&&H.blink()}}),w.monitor.on("sensor",function(a){"active"===a&&I&&I.blink(500,5e3)}),w.monitor.on("actuator",function(a,b,c){var d,e;"command"===a&&(d=b,e=b.options,v.controlActuator(d,e,!0,function(a,b){return a?(F.error("[sensors-controlActuator]",a),c&&c(a)):(F.info("[sensors-controlActuator]",b),c&&c(null,b))}))}),w.monitor.on("time",function(a){"synced"===a&&F.info("time: IN SYNC")}),w.monitor.on("store",function(a,b,c){"tooold"===a&&(F.fatal("[reboot] 1 day old data is not send oldestVal=%j queuedSize=%d",b,c),z.process("reboot",null,function(a,b){a?F.fatal("[reboot] failed err=",a):F.info("[reboot] result=",b)}))}),w.monitor.on("syncConfig",function(){t.sync(function(a){a?F.error("[sysConfig] sync err"):F.info("[sysConfig] done")})}),process.on("uncaughtException",function(a){F.error("[uncaughtException] "+a.stack)}),process.on("exit",function(){F.info("exit"),H&&H.off(),I&&I.off(),J&&J.off()}),process.on("SIGTERM",function(){F.info("SIGTERM"),process.exit()}),r&&(r.on("stats",function(a){F.debug("[memwatch] stats=",a)}),r.on("leak",function(a){F.error("[memwatch] leak=",a)})),L=q.createSocket("udp4"),M=28282,N="Thing+?",L.bind(M,function(){F.info("discovery BOUND port=[%d]",M)}),L.on("message",function(a,b){if(F.debug("discovery msg",""+a),F.debug("discovery rinfo",b),""+a!==N)return void F.info("discovery ignore unknown request");var c=new Buffer(JSON.stringify({id:B,name:t&&t.name,service:p.Server&&p.Server.service&&p.Server.service.host,mqtt:p.Server&&p.Server.mqtt&&p.Server.mqtt.host,serviceConn:u&&u.status.service.connected?"ok":u&&u.status.service.lastError,mqttConn:u&&u.status.mqtt.connected?"ok":u&&u.status.mqtt.lastError,uptime:""+(o.uptime()/60).toFixed(0)+"m"}));L.send(c,0,c.length,b.port,b.address),F.info("discovery reply myinfo=",""+c)})}),c.register("./etsi.js",function(a,b,c){"use strict";function p(a,b){var d="locationContainer"===Object.keys(a)[0],e=d?a.locationContainer.id:a.container.id;f||(f=c("m2mcore").httpBinder),f.primitiveRequest({targetID:n+"/containers",requestingEntity:n,primitiveType:d?"LOCATION_CONTAINER_CREATE_REQUEST":"CONTAINER_CREATE_REQUEST",rsc:a},function(a,c){return a||"STATUS_CREATED"!==c.statusCode?"STATUS_CONFLICT"===a.statusCode?b(null,n+"/containers/"+e):b(a||Error(c.statusCode)):b(a,c.resourceURI)})}var k,l,m,n,d=c("lodash"),e=c("log4js").getLogger("Main"),f=c("m2mcore").httpBinder,g=c("m2mcore").primitive,h=c("m2mcore").monitor,i=c("./sensors"),j=c("./gateway"),o={};a.exports.init=function(a,b,c){f.init({sclInfo:a},function(a){var b,k;return a?(e.error("httpBinder.init() "+a.stack),c(Error(f.init()))):(b=g.sclInfo,k=b.hSclBase+"/applications/"+b.id,0===b.protocol.indexOf("http")&&l(),d.each(i.sensorsData,function(a,b){m(b,b,j.sensors[b].type,i.sensorsData[b].interval,i.sensorsData[b].firstDelay)}),b=g.sclInfo,k=b.hSclBase+"/applications/"+b.id,e.info("... http initialized."),h.on("registration",function(){l()}),h.on("registration updated",function(){}),h.on("disconnect",function(a){e.error("disconnect url= ",a)}),c&&c())})},k=function(a,b){f.primitiveRequest({targetID:a+"/contentInstances",requestingEntity:n,primitiveType:"CONTENT_INSTANCE_CREATE_REQUEST",rsc:{contentInstance:{contentTypes:{contentType:["application/json"]},content:b}}},function(){})},l=function(){function a(a){var b=o[a];p({container:b.config},function(c,d){return c?void e.error("container creatin failure: ",c):(b.url=d,void e.debug("container:"+a+" url="+d))})}d.forOwn(o,function(b){e.debug("... making container for",b),a(b)})},m=function(a,b,c,d,e){var f=!1,g=null;o[a]={config:{id:b,maxNrOfInstances:100},url:g,available:f,type:c,interval:d,firstDelay:e}}}),c.register("./gateway.js",function(a,b,c){"use strict";var l,m,d=c("log4js").getLogger("Gateway"),e=c("config"),f=c("lodash"),g=c("retry"),h=c("./server"),i=c("./utils"),j=6e4,k=Number(e.Gateway&&e.Gateway.reportInterval,10)||j;k=j>k?j:k,l=i.statusError,m=a.exports={synced:!1,initialized:!1},m.putItem=function(a,b){void 0!==a.reportInterval&&(a.reportInterval=a.reportInterval>j?a.reportInterval:j),h.putGateway(a,b)},m.init=function(a,b){var c=this;this.id=a,this.name=e.Gateway.name,this.sensors=e.Sensors,this.reportInterval=k,this.initialized&&d.error("Gateway init, already initailzied"),i.getBoardInfo(function(a,i){!a&&i&&(c.board=i),d.info("[Gateway.init] board=",i),h._getGateway({embed:"sensors"},function(a,h){var i,k,l;return c.initialized=!0,a?(i=g.operation({retries:30,maxTimeout:72e5}),i.attempt(function(a){return c.synced?void d.warn("gateway.sync SUCCESS, tries:[%d]",a):void m.sync(function(b){return c.synced?void d.warn("gateway.sync SUCCESS, tries:[%d]",a):void(i.retry(b)&&d.error("gateway.sync FAILURE, tries:[%d]",a,b))})}),d.error("Gateway init, NOT IN SYNC, ignoring",a),b&&b()):(k={},void 0!==h.reportInterval&&(l=Number(h.reportInterval,10),l=l>j?l:j,c.reportInterval=l),e.Gateway.name=h.name?h.name:c.name,e.Gateway.reportInterval=c.reportInterval,h.sensors&&f.forEach(h.sensors,function(a){a&&f.isObject(a)&&a.id&&(k[a.id]=a)}),e.Sensors=k,c.sensors=e.Sensors,c.model=h.model,c.deviceModels=h.deviceModels,c.synced=!0,c.lastSync=Date.now(),d.warn("Gateway.init",JSON.stringify(c,null,2)),b&&b())})})},m.sync=function(a){var b=c("./sensors"),g=this;return this.initialized?void h._getGateway({embed:"sensors"},function(c,h){var i,k,l,n;return c?(404===c.statusCode?(d.error("Gateway not found and remove all sensors"),f.each(e.Sensors,function(a,c){b.removeSensor(c)})):d.error("Gateway init, server sync err=",c),a&&a(c)):(i={},void 0!==h.reportInterval&&(k=Number(h.reportInterval,10),k=k>j?k:j,g.reportInterval=k),e.Gateway.name=h.name?h.name:g.name,e.Gateway.reportInterval=g.reportInterval,h.sensors&&f.forEach(h.sensors,function(a){a&&f.isObject(a)&&a.id&&(i[a.id]=a)}),l=f.difference(f.keys(i),f.keys(m.sensors)),n=f.difference(f.keys(m.sensors),f.keys(i)),f.each(l,function(a){b.newSensor(a,i[a])}),f.each(n,function(a){b.removeSensor(a)}),g.synced=!0,g.lastSync=Date.now(),d.warn("Gateway.sync",JSON.stringify(g,null,2)),a&&a())}):(d.error("Gateway.sync, initialize first"),a&&a(l(400,"not initialized")))}}),c.register("./mqtt.js",function(a,b,c){"use strict";function w(b){v=[n,o,p,b].join("/"),u={base:v,logFilter:v+"/log/filter",log:v+"/log",status:v+"/status",mqttStatus:v+"/mqtt/status",rpcRequest:v+"/req",rpcResponse:v+"/res",getSensor:function(a){return[v,q,a].join("/")},getSensorStatus:function(a){return[v,q,a,"status"].join("/")},getActuator:function(a){return[v,r,a].join("/")}},a.exports.topic=u}var u,v,d=c("log4js").getLogger("MQTT"),e=c("./mqttHelper"),f=c("./remotecontroller"),g=c("lodash"),h=c("util"),i=c("./mqtt_log_appender"),j=c("./utils"),k=c("config"),l=c("async"),m=j.monitor,n="v",o="a",p="g",q="s",r="a",s=null,t=!1;m.on("store",function(a){return t&&"new"===a?s&&s.publishExt():void 0}),m.on("time",function(a){return"synced"===a?(t=!0,s&&s.publishExt()):void 0}),a.exports.init=function(b,c,j,n,o,p){w(j);var q={clientId:j,keepalive:Number(k.Gateway.reportInterval,10)/1e3*2,clean:!0,autopuback:!1,logger:d,will:{topic:u.mqttStatus,payload:"err",retain:!0}};d.info("[mqtt-init] opts",q),q.store=o,!p&&n&&"function"==typeof n&&(p=n,n=null),k.Server&&k.Server.mqtt&&(q.retryConnectInterval=k.Server.mqtt.retryConnectInterval,q.ackTimeout=k.Server.mqtt.ackTimeout);try{s=n?new e(b,c,h._extend(q,n)):new e(b,c,q)}catch(r){return p&&p(r)}return s?(s.on("connect",function(){try{s.subscribe([u.rpcRequest,u.logFilter],{qos:1},function(a,b){a?d.error("subscribe:"," err=",a):d.info("subscribe:"," granted=",b)})}catch(a){return d.error("mqtt init() fail / exception=",a),s.client.end()}try{s.publish(u.mqttStatus,"on",{qos:1,retain:!0}),m.emit("mqtt","connected"),d.info("mqtt CONNECTED")}catch(a){d.error("mqtt init() fail / exception2=",a)}}),s.on("close",function(){m.emit("mqtt","closed"),d.warn("mqtt close")}),s.on("error",function(a){m.emit("mqtt","error"),d.error("mqtt error",a)}),s.on("message",function(b,c,e,h){var j,k,n;if(d.debug("mqtt messages",b,c,e),b===u.rpcRequest){try{j=JSON.parse(c)}catch(m){}if(!j)return d.error("unknown Rpc message",c),h&&h();j&&j.params&&j.params.aws?(k=j.params.aws,delete j.params.aws,d.info("gatewayRpc:",j),j.params.aws=k):d.info("gatewayRpc:",j),l.series([function(b){if(f.checkRestart(j.method)){var c=setTimeout(function(){return c=null,b()},1e4),e={id:j.id,result:{stdout:"requireResart"}};a.exports.publish(u.rpcResponse,JSON.stringify(e),{qos:1,retain:!1},function(){c?(d.info("[gatewayRpc] requireRestart sent"),clearTimeout(c),b()):d.error("[gatewayRpc] restart puback took 10secs")})}else b()},function(a){f.process(j.method,j.params,function(b,c){var e;b?(d.error("remocon.process:",b),g.isObject(b)?b instanceof Error?b={code:-32e3,message:b&&""+b||"unknown error"}:b.code&&b.message||(b={code:b.code||-32e3,message:b.message||b&&""+b||"unknown error"}):b={code:-32e3,message:b&&""+b||"unknown error"},e={id:j.id,error:b}):(d.info("remocon.process done",j),e={id:j.id,result:c||""}),s.publish(u.rpcResponse,JSON.stringify(e),{qos:1,retain:!1}),a(b)})}],function(){return h&&h()})}else{if(b!==b.logFilter)return d.error("remocon unknown topic",b),h&&h();try{n=JSON.parse(c)}catch(m){"string"==typeof c&&(n=c)}n&&i.setLevelFilter(n)}}),p&&p()):p&&p(Error("mqtt.init failure"))},a.exports.publish=function(a,b,c,e){return d.info("sent(direct) [%s] : %s",a,b),"function"==typeof c&&(e=c,c=void 0),s&&s.publish(a,b,c||{qos:1,retain:!1},e)},a.exports.getStatus=function(){var a=s&&s.getStatus();return a},a.exports.log=function(a){s&&v&&s.publish(u.log,JSON.stringify(a),{qos:1,retain:!1})}}),c.register("./mqttHelper.js",function(a,b,c){"use strict";function n(a,b,c){if(!a||!b)throw Error("port and host are required");c||(c={}),this.port=a,this.host=b,this.opts=c,this.secure=c&&c.pfxPath?!0:!1,this.client=null,this.ackTimer=null,this.store=c.store,this.status={connected:!1,lastSentTime:null},c.reconnectPeriod=0,c.retryConnectInterval=c.retryConnectInterval||k,c.ackTimeout=c.ackTimeout||l;var f=this;!function g(){var a;d.debug("MH.init()"),f.reinitTimer=null,f.client||(f.status.connected=!1,f.client=a=!0===f.secure?e.createSecureClient(f.port,f.host,f.opts):e.createClient(f.port,f.host,f.opts),d.info("MH CREATE secure("+(f.secure?"yes":"no")+") "+f.host+":"+f.port),f.ackTimer=setTimeout(function(){f.status.connected=!1,d.warn("[mqtt.init] MH.ackTimer out : try disconnect"),f.ackTimer=null,f.client&&(f.client.destroy(),f.client=null)},f.opts.ackTimeout),a.on("message",f.emit.bind(f,"message")),a.on("connect",function(){f.ackTimer&&(clearTimeout(f.ackTimer),f.ackTimer=null),f.emit("connect"),f.status.connected=!0,f.publishExt()}),a.on("close",function(){return f.status.connected=!1,f.client&&(f.client.destroy(),f.client=null),f.ackTimer&&(clearTimeout(f.ackTimer),f.ackTimer=null),f.reinitTimer?void f.emit("close"):(f.reinitTimer=setTimeout(g.bind(f),f.opts.retryConnectInterval),void f.emit("close"))}),a.on("error",function(){return f.status.connected=!1,f.client&&(f.client.destroy(),f.client=null),f.ackTimer&&(clearTimeout(f.ackTimer),f.ackTimer=null),f.reinitTimer?void f.emit("error"):(f.reinitTimer=setTimeout(g.bind(f),f.opts.retryConnectInterval),void f.emit("error"))}))}()}var h,j,k,l,m,d=c("log4js").getLogger("MQTT"),e=c("mqtt"),f=c("events"),g=c("util");try{h=c("compress-buffer").compress}catch(i){d.warn("MODULES_NOT_SUPPORTED - compress-buffer")}j={qos:1,retain:!1},k=6e4,l=3e4,m=100,g.inherits(n,f.EventEmitter),n.prototype.publishExt=function(){var b,c,a=this;this.client&&0!==this.store.size()&&(this.ackTimer||(this.store.getFirst(function(c,d){b=a.store.encode(d),b&&(b.seq=c)}),b&&(this.ackTimer=setTimeout(function(){a.status.connected=!1,d.warn("MH.ackTimer out : try disconnect"),a.ackTimer=null,a.client&&(a.client.destroy(),a.client=null)},this.opts.ackTimeout),d.info("MH SENDING ("+b.seq+") "+b.topic+" : "+(b.message.length>100?b.message.substr(0,100)+" ...":b.message)),c=h&&b.message&&b.message.length>m?h(new Buffer(b.message)):b.message,this.client.publish(b.topic,c,j,function(c){a.status.connected=!0,a.status.lastSentTime=Date.now(),c&&d.error("MH.publish/callback error",c),a.ackTimer&&(clearTimeout(a.ackTimer),a.ackTimer=null),d.info("MH SENT    ("+b.seq+") "+b.topic+" : "+(b.message.length>100?b.message.substr(0,100)+" ...":b.message)),a.store.rm(b.seq),process.nextTick(a.publishExt.bind(a))}))))},n.prototype.publish=function(){this.client?this.client.publish.apply(this.client,arguments):d.error("MH.publish fail")},n.prototype.subscribe=function(){this.client?this.client.subscribe.apply(this.client,arguments):d.error("MH.subscribe fail")},n.prototype.getStatus=function(){return this.status},a.exports=n}),c.register("./mqtt_log_appender.js",function(a,b,c){"use strict";function j(a){a&&("string"==typeof a?i=f.toLevel(a,i):(i={},g.each(a,function(a,b){i[b]=f.toLevel(a)})))}function k(a){return a&&j(a),function(a){var b=a.categoryName;a.level.isGreaterThanOrEqualTo(i[b]||i)&&h.log({l:a.level.levelStr.charAt(0),c:b,t:Date.parse(a.startTime),d:e.messagePassThroughLayout(a)})}}function l(a){var b=a&&a.level;return k(b)}var d=c("log4js"),e=d.layouts,f=d.levels,g=c("lodash"),h=c("./mqtt"),i=f.FATAL;b.appender=k,b.configure=l,b.setLevelFilter=j}),c.register("./remotecontroller.js",function(a,b,c){"use strict";function t(a,b){m(a,{encoding:"utf8",timeout:12e4,maxBuffer:512e3,killSignal:"SIGKILL",cwd:__dirname,env:null},function(c,d,e){var f;return c&&(f={code:-32e3,message:c&&""+c||"unknown error"},l.error(a,f)),e&&l.error(a,e),b&&b(f,{stdout:d,stderr:e||void 0})})}var u,v,d=c("os"),e=c("async"),f=c("lodash"),g=c("fs"),h=c("path"),i=c("crontab"),j=c("config"),k=c("ini"),l=c("log4js").getLogger("Main"),m=c("child_process").exec,n=c("./utils"),o=n.monitor,p="/etc/wvdial.conf",q="Dialer Defaults",r={Username:"",Password:"",Enable:!1,"Stupid mode":"yes"},s={};f.each(["wvdial","wvdialconf"],function(a){m("which "+a,function(b){s[a]=!b})}),u={controlActuator:function(a,b,c){o.emit("actuator","command",b,c)},timeSync:function(a,b,c){var d,e;return b&&b.time&&f.isNumber(b.time)&&n.isValidTime(b.time)?(e=b.time/1e3,n.isValidTime()?(l.info("time sync already"),c&&c()):(l.warn("time sync @"+e),void t("date -s @"+e+"; service ntp restart",c))):(d={code:-32e3,message:"invalid time"},l.error("invalid timesync req"),c&&c(d))},poweroff:function(a,b,c){return t("sh ./update/poweroff.sh &"),c&&c()},reboot:function(a,b,c){return t("sh ./update/reboot.sh &"),c&&c()},resetConfig:function(a,b,c){var d=process.env.NODE_CONFIG_DIR?process.env.NODE_CONFIG_DIR:h.join(__dirname,"config");t("rm -f "+h.join(d,"runtime.json"),function(){return t("sh ./update/restart.sh &"),c&&c()})},syncConfig:function(a,b,c){return o.emit("syncConfig"),c&&c()},rebootEveryday:function(a,b,c){i.load(function(a,d){var e,g,h,i,j;return a?(e={code:-32e3,message:""+a},c&&c(e)):(g=b&&b.cmd,h=b&&parseInt(b.hourAt,10),i=b&&parseInt(b.minAt,10),g?(d.remove(d.findCommand(g)),f.isNumber(h)?(j=d.create(g),j.hour().on(h),j.minute().on(i||0),void d.save(function(a){return a?(e={code:-32e3,message:"cron save error="+a},c&&c(e)):c&&c()})):c&&c()):(e={code:-32e3,message:"invalid params="+JSON.stringify(b)},c&&c(e)))})},restart:function(a,b,c){return t("sh ./update/restart.sh &"),c&&c()},swUpdate:function(a,b,c){return t("cd "+__dirname+"; sh ./update/update.sh &"),c&&c()},shell:function(a,b,c){var d;return b&&b.cmd?void t(b.cmd,c):(d={code:-32e3,message:"null cmd"},c&&c(d))},modem:function(a,b,c){var h,i,n,d={};return!b||!b.cmd||"getModemConfig"!==b.cmd&&"setModemConfig"!==b.cmd?(h={code:-32e3,message:"invalid params="+b},c&&c(h)):"setModemConfig"!==b.cmd||b.config&&b.modem?s.wvdial?(n=!1,void e.series([function(a){m("/etc/init.d/wvdial.sh status",function(b){return b||(n=!0),a()})},function(a){return"getModemConfig"!==b.cmd&&n?void m("/etc/init.d/wvdial.sh stop",function(){return n=!1,a()}):a()},function(a){if(n)return a();var c="getModemConfig"===b.cmd?"/dev/null":p;m("wvdialconf "+c,function(b){return b?a("MODEM, not found"):a()})},function(a){try{i=k.parse(g.readFileSync(p,"utf-8"))}catch(b){l.error("wvdialConf parse",b)}return i&&i[q]?a():a(Error("wvdial conf not found"))}],function(a){if(a)return l.error(b.cmd,"err",a),h={code:-32e3,message:""+a},c&&c(h);var e=i[q];return"setModemConfig"===b.cmd&&(j.Modem=b.config,e.Phone="*99#",(f.isUndefined(e.Baud)||f.isNaN(+e.Baud)||+e.Baud<115200)&&(e.Baud=115200),f.defaults(e,r),e.Username=b.config.APN_USER,e.Password=b.config.APN_PASS,e.Init3='AT+CGDCONT=1, "IP", "'+b.config.APN+'"',e.Enable=!!b.config.ENABLED,g.writeFileSync(p,k.stringify(i)),e.Enable?m("/etc/init.d/wvdial.sh restart",function(a,b,c){l.info("wvdial restart",a,b,c)}):m("/etc/init.d/wvdial.sh stop",function(a,b,c){l.info("wvdial stop",a,b,c)}),l.info("setModemConfig",e)),d.config=j.Modem,d.modem=e.Modem,d.modemType=e["Modem Type"],c&&c(null,[d])})):(h={code:-32e3,message:"modem scanner is not available"},c&&c(h)):(h={code:-32e3,message:"setModemConfig requires params.config and modemId"},c&&c(h))},netInfo:function(a,b,c){var h,l,o,g=["lo","usb"],i=b&&b.ifName,j=[],k=[],n=d.networkInterfaces();return f.isEmpty(n)||i&&!n[i]?(h={code:-32e3,message:"not found ???"},c&&c(h)):(i&&(o=n[i],n={},n[i]=o),f.each(n,function(a,b){var c=f.where(a,{family:"IPv4"});f.any(g,function(a){return 0===b.indexOf(a)})||f.isEmpty(c)||(j.push(b),k.push(c[0]))}),l=f.zipObject(j,k),void e.eachSeries(j,function(a,b){m("ifconfig "+a,function(c,d){if(d){var e=d.match(/RX\ bytes:(\d+).*TX\ bytes:(\d+)/);l[a].RxBytes=e[1],l[a].TxBytes=e[2]}b()})},function(){var a=[];return f.each(l,function(b,c){a.push(f.extend({id:c},b))}),f.isEmpty(a)?(h={code:-32e3,message:"not found"},c&&c(h)):i?c&&c(null,a[0]):c&&c(null,a)}))},swInfo:function(a,b,c){var d,e={local:{},remote:{}};d="cd "+__dirname+"; sh ./update/version.sh",m(d,function(a,b,g){var i,j,h={};return i=b&&b.split("\n"),l.debug(b,i),f.each(i,function(a){var b=/^@@(\w+)/.exec(a);b?(j=b[1],h[j]={lines:[]}):h[j].lines.push(a)}),f.isEmpty(h)?l.error("cmd=",d,"err=",a,"stdout=",b,"stderr=",g):f.each(e,function(a,b){h[b]&&h[b].lines&&(e[b]={version:h[b].lines[0],date:h[b].lines[1],comment:h[b].lines[2]})}),c&&"function"==typeof c?c(null,e):void 0})},setProperty:function(a,b,c){return l.info("[RMCTRL] ignore setProperty for now",b),c&&c()}},v={controlActuator:{proc:u.controlActuator,restart:!1},setProperty:{proc:u.setProperty,restart:!1},timeSync:{proc:u.timeSync,restart:!1},poweroff:{proc:u.poweroff,restart:!0},reboot:{proc:u.reboot,restart:!0},resetConfig:{proc:u.resetConfig,restart:!0},rebootEveryday:{proc:u.rebootEveryday,restart:!1},restart:{proc:u.restart,restart:!0},swUpdate:{proc:u.swUpdate,restart:!0},shell:{proc:u.shell,restart:!1},modem:{proc:u.modem,restart:!1},netInfo:{proc:u.netInfo,restart:!1},swInfo:{proc:u.swInfo,restart:!1},syncConfig:{proc:u.syncConfig,restart:!1}},a.exports.process=function(a,b,c){var e,d=a&&v[a]&&v[a].proc;return d?void d(a,b,c):(l.info("[RMCTRL] unknown method:",a,v[a]),e={code:-32e3,message:"unknown command:"+a},c&&c(e))},a.exports.checkRestart=function(a){return v[a]&&v[a].restart?!0:!1}}),c.register("./routes.js",function(a,b,c){"use strict";var d=c("log4js").getLogger("Main"),e=c("lodash"),f=c("config"),g=c("fs"),h=c("./gateway"),i=c("./remotecontroller"),j=c("./server"),k=c("./sensors");a.exports.gatewayInfo=function(){return function(a,b){h.sync(function(){b.send(JSON.stringify(h))})}},a.exports.gatewayConfig=function(){return function(a,b){var c=a.body;h.putItem(c,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})}},a.exports.gatewayControl=function(){return function(a,b){var c=a.query.command,f=["poweroff","reboot","restart","swUpdate","resetConfig"];return c&&e.contains(f,c)?(d.info("[HTTPAPI] gatwayControl",c),void i.process(c,null,function(a,e){d.info("[HTTPAPI] gatwayControl",c,a||e),a?b.send(404,"command failure"+a):b.send(e)})):b.send(400,"bad request: invalid param")}},a.exports.serverInfo=function(){return function(a,b){j.statusUpdate(function(){var a=["config","status","registered"],c={};e.each(a,function(a){c[a]=j[a]}),d.info("[HTTPAPI] /api/server/info",JSON.stringify(c,null,2)),b.send(c)})}},a.exports.softwareInfo=function(){return function(a,b){i.process("swInfo",null,function(a,c){d.info("[HTTPAPI] /api/software/info",a||c),a?b.send(404,"not found"):b.send(c)})}},a.exports.sensorData=function(){return function(a,b){d.info("[HTTPAPI] /api/sensor/data",JSON.stringify(k.sensorsData)),b.send(JSON.stringify(k.sensorsData))}},a.exports.sensorDiscover=function(){return function(a,b){var c=a.query.driverName;k.discover(c,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})}},a.exports.getSensorItem=function(){return function(a,b){var d,c=a.params.id;return c?(d={driverName:a.query.driverName,model:a.query.model,network:a.query.network,address:a.query.address},void k.getItem(c,d,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})):b.send(400,"empty sensorId")}},a.exports.delSensorItem=function(){return function(a,b){var c=a.params.id;return c?void k.delItem(c,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)}):b.send(400,"empty sensorId")}},a.exports.postSensorItem=function(){return function(a,b){var d,c=a.body.id;return c?(d=a.body,d.reqId=c,delete d.id,d.series="sensor"===a.body.category?c:null,d.owner=h.id,d.ctime=Date.now(),void k.postItem(d,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})):b.send(400,"empty sensorId")}},a.exports.certUpload=function(){return function(a,b){var c=a.files.cert;b.setHeader("Content-Type","text/html"),j.postCert(c,function(a,c){b.send(a?{statusCode:a.statusCode,msg:""+a}:{statusCode:200,msg:c})})}},a.exports.getInterfaces=function(){return function(a,b){i.process("netInfo",null,function(a,c){d.info("[HTTPAPI] getInterfaces netInfo",a||c),a?b.send(404,"not found"):b.send(c)})}},a.exports.getInterfaceItem=function(){return function(a,b){var c=a.params.id;return c?void i.process("netInfo",{ifName:c},function(a,e){d.info("[HTTPAPI] getInterface netInfo",c,a||e),a?b.send(404,"not found"):b.send(e)}):b.send(400,"empty id")}},a.exports.getModems=function(){return function(a,b){i.process("modem",{cmd:"getModemConfig"},function(a,c){d.info("[HTTPAPI] getInterface modem, getModemConfig",a&&a.message||c),a?b.send(404,"not found"):b.send(c)})}},a.exports.getModemItem=function(){return function(a,b){var c=a.params.id&&decodeURIComponent(a.params.id);i.process("modem",{cmd:"getModemConfig",modem:c},function(a,e){d.info("[HTTPAPI] getInterface modem, getModemConfig",c,a||e),a||!e||0===e.length?b.send(404,"not found"):b.send(e[0])})}},a.exports.putModemItem=function(){return function(a,b){var c=a.params.id&&decodeURIComponent(a.params.id),e=a.body;i.process("modem",{cmd:"setModemConfig",modem:c,config:e},function(a,e){d.info("[HTTPAPI] getInterface modem, setModemConfig",c,a||e),a||!e||0===e.length?b.send(400,"err="+a):b.send(e[0])})}},a.exports.chPasswd=function(){return function(a,b){var c=a.body.currentPassword,d=a.body.newPassword;c&&d&&f.Auth.admin===c?(f.Auth.admin=d,b.end()):b.send(400,"password mismatch or missing new password")}},a.exports.getModemStats=function(){return function(a,b){var c="/run/umtskeeper/umtskeeper.stat";g.readFile(c,function(a,c){var e,f={},g={};a&&d.error("[ModemStats]",a),e=["rxBDays","rxBDaysLastMonth","rxBHrs","rxBHrsAcc","rxBHrsYesday","rxBMonth","rxBQHrs","rxBQHrsAcc","rxBQHrsYesday","rxBToday","rxBTot","rxBYesday","txBDays","txBDaysLastMonth","txBHrs","txBHrsAcc","txBHrsYesday","txBMonth","txBQHrs","txBQHrsAcc","txBQHrsYesday","txBToday","txBTot","txBYesday"],e.forEach(function(a){var b=RegExp(a+"':\\s(.*),\\s\\\\");f[a]=(""+c).match(b)[1]}),d.info("[ModemStats] Stats",f),g.stats=f,g.gateway=h,a||!f?b.send(404,"not found"):b.send(g)})}},a.exports.controlActuator=function(){return function(a,b){var c,d;c=a.body,d=a.body.options,k.controlActuator(c,d,!1,function(a,c){a?(b.writeHead(a.statusCode||400),b.end(a&&""+a)):b.send(c)})}},a.exports.getSensorDrivers=function(){return function(a,b){j.getSensorDrivers(function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})}}}),c.register("./sensors.js",function(a,b,c){"use strict";function I(a,b){return a&&a.replace(/\{(\w+)\}/g,function(a,c){return b[c]})}function J(a){var b,c,f,h,i,j,l,m,p,v;if(!(a&&a.id&&n.sensors&&n.sensors[a.id]))return void d.warn("invalid sensor data or, sensor  no longer exit",a);if(b=n.reportInterval/1e3*1.5,c=a.status,f=a.id,h=n.sensors[f].type,i=a.result?a.result[h]:null,j=a.time&&a.time[h]?a.time[h]:k.now(),u.emit("sensor","active"),p=H.sensorsData[f].status,"off"===c)H.sensorsData[f].status=B,d.warn("OFF from driver","index=",H.sensorsData[f],"id=",f);else if("error"===c)H.sensorsData[f].status=C,d.warn("Can not get data from sensor",a.message,"index=",H.sensorsData[f],"id=",f);else{if("ok"!==c)return void d.error("Unexpected result code",c,"id=",f);if(d.debug(f+" => "+i),null===i||void 0===i)return H.sensorsData[f].status=A,void d.info("sensorDataHandler: no value, status(ok) only","id=",f);v={v:i,u:parseInt(1e3*g.uptime(),10)},r.isValidTime(j)&&(v.t=j),H.sensorsData[f].latest=v,H.sensorsData[f].values.push(v),H.sensorsData[f].status=A,H.sensorsData[f].type=h,q.getSensorProperties(e.Sensors[f].model).onChange&&(t.push({topic:s.topic.getSensor(f),message:H.sensorsData[f].values}),H.sensorsData[f].values=[])}m=H.sensorsData[f].status,p!==m&&(l=m===A?b:-1,d.info("[%s] sensor status: %s -> %s",f,p,m),o.isConnected("mqtt")?s.publish(s.topic.getSensorStatus(f),""+[m,l]):d.warn("sensor status: NOT SENT due to mqtt unavailable"))}function K(a){d.info("sensorChangeHandler() currentData=",a),J(a)}function L(a,b){var c,e,f,g,h,i,j;return b&&b.model&&(e=q.getSensorProperties(b.model)),e?(g="sensorjs",h=b.network||e.supportedNetworks[0],i=e.addressable?b.address:b.address||a,j=b.model,f=g+"://"+["",h,i,j,a].join("/"),b.options&&(f+="?"+l.stringify(b.options)),c=q.createSensor(f),d.info("sensorUrl",f),c):(d.error("sensor properties are necessary",b),null)}var w,y,z,A,B,C,D,E,F,G,H,d=c("log4js").getLogger("Sensors"),e=c("config"),f=c("util"),g=c("os"),i=(c("url"),c("path")),j=c("fs"),k=c("lodash"),l=c("querystring"),m=c("async"),n=c("./gateway"),o=c("./server"),p=c("sensorjs"),q=p.sensor,r=c("./utils"),s=c("./mqtt"),t=c("./store"),u=r.monitor,v=k.filter(j.readdirSync(i.join(__dirname,"node_modules")),function(a){return-1!==a.indexOf("sensorjs-")});k.each(v,function(a){try{q.addSensorPackage(c(a))}catch(b){d.warn("MODULES_NOT_SUPPORTED - "+a)}});try{w=c("aws-sdk")}catch(x){d.warn("MODULES_NOT_SUPPORTED - aws-sdk")}y=5e3,z=Number(e.Gateway&&e.Gateway.firstDelay,10)||y,A="on",B="off",C="err",D=6e4,E=!0,F=r.statusError,G=!1,H=a.exports={sensors:{},sensorsData:{}},u.on("mqtt",function(a){G&&"connected"===a&&H.mqttPublishAll()}),H._newSensor=function(a,b){var c,e,f;H.sensors[a]&&(d.warn("remove before adding sensor",a),H._removeSensor(a)),c={model:b.model,macAddress:n.id},b&&b.model&&(e=q.getSensorProperties(b.model)),f=L(a,b),"actuator"===b.category?H.sensors[a]=f:e&&f?(H.sensorsData[a]={values:[],latest:null,_time:null,firstDelay:z,status:null,interval:e.recommendedInterval||D},d.info("newSensor:",a,c),e.onChange?(f.on("change",K),f.listen("change")):(f.on("data",J),f.listen(c.retriveInterval)),H.sensors[a]=f):d.error("newSensor failure / driverName=",b.driverName,"sensorId=",a,"options=",c)
},H.newSensor=function(a,b){e.Sensors[a]=b,e.Sensors=f._extend({},e.Sensors),n.sensors=e.Sensors,H._newSensor(a,b)},H.updateSensor=function(a,b){e.Sensors[a]=b,e.Sensors=f._extend({},e.Sensors),n.sensors=e.Sensors},H._removeSensor=function(a){var b=H.sensors[a];b&&(b.clear&&(b.clear(),d.info("sensor is cleared",a)),b.removeListener("data",J),b.removeListener("change",K),delete H.sensors[a],k.has(H.sensorsData,a)&&delete H.sensorsData[a])},H.removeSensor=function(a){d.info("removeSensor:",a),e.Sensors[a]&&(delete e.Sensors[a],e.Sensors=f._extend({},e.Sensors),n.sensors=e.Sensors),H._removeSensor(a)},H.discover=function(a,b){var c,e=[],f=[],g=q.getSensorProperties(a);return g&&g.discoverable?void q.discover(a,function(a,g){return d.info("discovered devices info",g),a?void d.error("err=",a.stack):g.length>0?(k.each(g,function(a){k.each(a.sensorUrls,function(a){e.push(q.parseSensorUrl(a))})}),k.each(n.sensors,function(a,b){for(var c=e.length-1;c>=0;c--)e[c].id===b&&(e.splice(c,1),f.push(b))}),d.info("[HTTPAPI] /api/discover - founds",e),c={"new":e,registered:f},b&&b(null,c)):b&&b(F(404,"not found"))}):b&&b(F(404,"not discoverable"))},H.getItem=function(a,b,c){var g,h,i,e=b.model,f={model:e,macAddress:n.id};return a&&e?(d.info("[HTTPAPI] GET /api/sensors/:id sensorId=",a,"model=",e,"options=",f),b&&b.model&&(g=q.getSensorProperties(b.model)),(h=L(a,b))?(i=setTimeout(function(){return d.info("[HTTPAPI] GET /api/sensors/:id, timeout",1.5*g.recommendedInterval),h&&h.clear&&h.clear(),h=null,c&&c(F(404,"not found"))},1.5*g.recommendedInterval),h.once("data",function(a){return clearTimeout(i),h?(d.info("[HTTPAPI] GET /api/sensors/:id, sent response and sensor is deleted",h.id),h.clear&&h.clear(),h=null,c&&c(null,a)):void 0}),void h.listen(0)):(d.warn("createSensor() failure / model=",e,"sensorId=",a,"options=",f),c&&c(F(404,"not found in local sensor list")))):c&&c(F(400,"Sensor ID and model are required"))},H.delItem=function(a,b){o.delSensor(a,function(c){return c?b&&b(F(400,"failure to delete sensor="+a)):(H.removeSensor(a),b&&b(null,JSON.stringify(n)))})},H.postItem=function(a,b){var c=a.reqId;return d.info("postItem - sensorId",c),o.isConnected()?void o.upsertSensor(c,a,function(a,e){return a?b&&b(a):(n.sensors[c]?(d.warn("postItem: already exist",c,n.sensors[c]),H.updateSensor(c,e),d.info("postItem - sensor info is updated")):(H.newSensor(c,e),d.info("postItem - new sensor is added",c,e)),b&&b(null,JSON.stringify(n.sensors)))}):b&&b(F(403,"registration is required or not connected"))},H.controlActuator=function(a,b,c,e){var h,f=a.id,g=a.aws;if(delete a.aws,k.has(H.sensors,f))h=H.sensors[f],d.info("[sensors] actuator is existing",f);else{if(!a.id||!a.model)return e&&e(F(400,"Sensor ID and model are required"));if(d.info("[HTTPAPI] POST /api/actuator/control sensorInfo=",a),h=L(f,a),setTimeout(function(){h.clear(),h=null},5e3),!h)return d.warn("controlActuator() failure/ sensorInfo=",a),e&&e(F(404,"not found in local sensor list"))}h.set(a.cmd,b,function(a,b){var f,h,i,j={};return a||!b||!k.isObject(b)&&!k.isString(b)?(i="invalid result type",c&&(j.code=-32e3,j.message=a&&a.message||i,i=j),d.debug("[Sensors.controlActuator] / error",i),e&&e(i,b)):(d.info("[sensors/controlActuator] return result",b),w&&g&&g.config&&g.upload?(d.info("[sensors/controlActuator] upload"),h=g.upload,w.config.update(g.config),f=new w.S3,h.Body=b.content,h.ContentType=b.contentType,void f.putObject(h,function(a){return a?(i=""+a,c&&(j.code=-32e3,j.message=i,i=j),d.error("[sensors/controlActuator] upload err",i)):(d.info("[sensors/controlActuator] Successfully uploaded"),b._uploaded=!0,delete b.content),e&&e(i,b)})):(d.info("controlActuator() no upload Info"),e&&e(i,b)))})},H.mqttPublishAll=function(){var b,e,a=(n.reportInterval||6e4)/1e3*1.5,c={};o.isConnected("mqtt")&&u.emit("mqtt","active"),b=!o.timeSynced||t.fsFull||t.memFull?{status:C,duration:-1,sensors:[]}:{status:A,duration:a,sensors:[]},k.each(H.sensorsData,function(d,e){var f=d.status;f===A&&d.values.length>0&&(E?c[e]=d.values:t.push({topic:s.topic.getSensor(e),message:d.values}),d.values=[]),b.sensors.push({id:e,status:f||B,duration:f===A?a:-1})}),E&&!k.isEmpty(c)&&t.push({topic:s.topic.base,message:c,multi:!0}),k.each(k.where(n.sensors,{category:"actuator"}),function(c){var e,d=c.id;if(!b.sensors[d]){try{e=H.sensors&&H.sensors[d]&&H.sensors[d].getStatus()}catch(f){}b.sensors.push({id:d,status:e||B,duration:e===A?a:-1})}}),d.info("[%s] status",n.id,b),e=[b.status,b.duration],e=e.concat(k.zip(k.pluck(b.sensors,"id"),k.pluck(b.sensors,"status"),k.pluck(b.sensors,"duration"))),o.isConnected("mqtt")?s.publish(s.topic.status,""+e):d.warn("Gateway status: NOT SENT due to unavailable mqtt")},H.init=function(a){return G?a&&a():(G=!0,k.each(n.sensors,function(a,b){H._newSensor(b,a)}),n.model&&n.deviceModels&&m.waterfall([function(a){o.getSensorDrivers(function(b,c){return b?a(b):a(null,c)})},function(a,b){o.getGatewayModels(function(c,d){return c?b(c):b(null,a,d)})},function(a,b,c){var e=k.find(b,{id:n.model}),f=k.pluck(n.sensors,"id");if(!n.deviceModels)return c();if("string"==typeof n.deviceModels){d.info("[sensors/init] string type",n.deviceModels);try{n.deviceModels=JSON.parse(n.deviceModels)}catch(g){return d.info("[sensors/init] JSON parse error",n.deviceModels),c()}}m.eachSeries(n.deviceModels,function(b,c){var g=k.find(e&&e.deviceModels,{id:b.model});return g&&g.sensors?void m.eachSeries(g.sensors,function(c,e){var h=k.find(a,{id:c.driverName});return h.discoverable&&"true"===h.discoverable?void H.discover(c.driverName,function(a,i){var j=[];return a?(d.error("[init] discover err",a),e()):k.isEmpty(i.new)?(d.info("[init] discover none"),e()):(k.forEach(i.new,function(a){var i,e=a.id;return k.contains(f,e)?(d.debug("[init] already registered",e),!0):c.model&&c.model!==a.model||c.network!==a.device.sensorNetwork?(d.debug("[init] mismatch model or network",e,c,JSON.stringify(a,null,2)),!0):(i=k.clone(c,!0),i.reqId=e,i.name=c.type+"_"+e,i.owner=n.id,i.ctime=Date.now(),i.series=e,i.address=a.device.address,a.options&&(i.options=a.options),h.commands&&(i.commands=h.commands),i.deviceId=b.id?b.id:g.idTemplate?I(g.idTemplate,{gatewayId:i.owner,deviceAddress:i.address}):e,j.push(i),void f.push(e))}),d.debug("[init] post sensors",j),k.size(j)>0?void m.eachSeries(j,function(a,b){H.postItem(a,function(a){return a?d.error("[sensors] init - error with Sensors.postItem",a):d.info("[sensors] init - success with Sensors.postItem"),b()})},function(){var a=k.unique(k.pluck(j,"deviceId")),b=k.difference(a,n.devices);d.info("[sensors] init - creating devices",a,b),m.eachSeries(b,function(a,b){var c={reqId:a,name:a};o.upsertDevice(a,c,function(c){return c?d.error("[sensors] init - error on creating a device: ",a):d.info("[sensors] init - success on creating a device: ",a),b(c)})},e)}):e())}):(d.debug("[init] non discoverable sensor",c,h.discoverable),e())},function(a){return a&&d.error("[sensors] init - adding unregistered sensors error - deviceModel.sensors",a),c(a)}):(d.warn("[sensors/init] - No Device model",b.model),c())},function(a){return a&&d.error("[sensors] init - adding unregistered sensors error - Gateway.deviceModels",a),c(a)})}],function(a,b){a?d.error("[sensors] init - adding unregistered sensors error",a):d.info("[sensors] init done",b)}),d.warn("... Start gathering data - REPORT_INTERVAL(%s) ...",n.reportInterval),setTimeout(function(){setInterval(H.mqttPublishAll,n.reportInterval)},z+5e3),a&&a())}}),c.register("./server.js",function(a,b,c){"use strict";var g,h,i,j,k,l,m,n,o,p,q,r,s,d=c("log4js").getLogger("Server"),e=c("config"),f=c("lodash");e=c("config"),g=c("http"),h=c("fs"),i=c("async"),j=c("request"),k=c("querystring"),l=c("./utils"),m=c("./remotecontroller"),n=c("./store"),o=c("./mqtt"),p=l.statusError,q=l.monitor,r=e.Server&&e.Server.timeSyncCheckInterval||6e4,s=a.exports={config:{mqtt:e.Server.mqtt,service:e.Server.service},requestOptions:{json:!0,timeout:6e4},status:{mqtt:{connected:!1,lastError:""},service:{connected:!1,lastError:""}},baseUrl:null,gatewayUrl:null,gatewayId:null,registered:!1,timeSynced:!1},q.on("mqtt",function(a){switch(a){case"connected":s.status.mqtt.connected=!0;break;case"close":case"error":s.status.mqtt.connected=!1}}),s.isConnected=function(a){return"mqtt"===a?this.status.mqtt.connected:this.registered&&this.status.service.connected},s.init=function(a,b){s.registered=!0,"https"===e.Server.service.protocol?h.existsSync(e.Gateway.CERT_FILE_PATH)?(s.requestOptions.pfx=h.readFileSync(e.Gateway.CERT_FILE_PATH),s.requestOptions.rejectUnauthorized=!0,s.requestOptions.passphrase=a):s.registered=!1:"http"===e.Server.service.protocol&&(s.requestOptions.headers={gateway:a}),s.gatewayId=a,s.baseUrl=e.Server.service.protocol+"://"+e.Server.service.host+("80"===e.Server.service.port?"":":"+e.Server.service.port),s.gatewayUrl=s.baseUrl+"/api/gateways/"+a,s.timeSynced=!1,function c(){l.isValidTime()?(n.timeSync(),s.timeSynced=!0,q.emit("time","synced")):setTimeout(c,r)}(),s.timeSynced||d.warn("time: NOT IN SYNC"),s.statusUpdate(function(a){return a&&d.warn("error Sever.update on init",a),b&&b()})},s._getGateway=function(a,b){var c=s.gatewayUrl;a&&(c+="?"+k.stringify(a)),j.get(c,f.clone(s.requestOptions),function(a,c,d){return a?b&&b(a):2!==Math.floor(c.statusCode/100)?b&&b(p(c.statusCode)):b&&b(null,d)})},s.getGateway=function(a,b){return s.isConnected()?s._getGateway(a,b):b&&b(p(403,"registration is required or not connected"))},s.putGateway=function(a,b){var c,e={};return s.isConnected()?(d.info("putGateway ",a),a.reportInterval&&(c=Number(a.reportInterval,10),delete a.reportInterval),void i.series([function(b){return f.isEmpty(a)?b():void j.put(s.gatewayUrl,f.extend({body:a},s.requestOptions),function(a,c,f){return a||2!==Math.floor(c.statusCode/100)?(d.error("putGateway err=",a||p(c.statusCode)),b(a||p(c.statusCode))):(e=f,void b())})},function(a){return f.isNull(c)||f.isUndefined(c)?a():void j.post(s.baseUrl+"/api/manageGateway",f.extend({body:{id:s.gatewayId,act:"setProperty",params:{reportInterval:c}}},s.requestOptions),function(b,f){return b||2!==Math.floor(f.statusCode/100)?(d.error("manageGateway err=",b||f.statusCode),a(b||p(f.statusCode))):(e||(e={}),e.reportInterval=c,void a(null))})}],function(a){return a?d.error("putGateway result err=",a):d.info("putGateway result",e),b&&b(a,e)})):b&&b(p(403,"registration is required or not connected"))},s.statusUpdate=function(a){var b=this;return s.registered?void i.forEachSeries(Object.keys(this.config),function(a,c){var f,e=b.config[a];return 0===e.protocol.indexOf("mqtt")?(f=o&&o.getStatus(),s.status[a].connected=f&&f.connected||!1,c()):0!==e.protocol.indexOf("http")?(d.error("Unknown Server"),c()):void s._getGateway(null,function(b,d){var e;if(b){if(s.status[a].connected=!1,b.statusCode)e="Gateway - "+g.STATUS_CODES[b.statusCode];else switch(b.message){case"mac verify failure":e="Certificate is not for this gateway";break;default:e=""+b}s.status[a].lastError=e}else d&&(s.status[a].connected=!0);return c()})},function(c){return f.each(b.config,function(a,b){d.info("[%s] - %s",b,s.status&&s.status[b].connected?"CONNECTED":"DISCONNECTED")}),a&&a(c)}):a(Error("need registration"))},s.upsertSensor=function(a,b,c){var e;i.series([function(c){b.reqId||(b.reqId=a),j.post(s.gatewayUrl+"/sensors",f.extend({body:b},s.requestOptions),function(g,h,i){if(g||409!==h.statusCode){if(g||2!==Math.floor(h.statusCode/100))return d.error("post Sensor failure",a,g||h.statusCode),c(g);d.debug("upsert(post) sensor",i),e=i,c()}else delete b.reqId,j.put(s.gatewayUrl+"/sensors/"+a,f.extend({body:b},s.requestOptions),function(b,f,g){return b||2!==Math.floor(f.statusCode/100)?(d.error("put Sensor failure",a,b||f.statusCode),c(b||p(f.statusCode))):(d.debug("upsert(put) sensor",g),e=g,c())})})},function(b){s.getGateway(null,function(e,g){if(e)return d.error("gateway get",e),c&&b(e);var h=g.sensors;h=f.pull(f.uniq(h),"null","undefined",null,void 0),f.contains(h,a)||h.push(a),s.putGateway({sensors:h},function(a,c){return a&&d.error("gateway sensorlist update failure",a),b(a,c)})})}],function(a){return a&&d.error("upsert sensor",a),c&&c(a,e)})},s.delSensor=function(a,b){return s.isConnected()?void i.series([function(b){j.del(s.gatewayUrl+"/sensors/"+a,f.clone(s.requestOptions),function(c,e){return c||2!==Math.floor(e.statusCode/100)?(d.error("del Sensor failure",c||e.statusCode),b(c)):(d.info("del sensor",a),b())})},function(c){s.getGateway(null,function(e,g){if(e)return d.error("gateway get",e),b&&c(e);var h=g.sensors;h=f.pull(f.uniq(h),"null","undefined",null,void 0),f.pull(h,a),s.putGateway({sensors:h},function(a,b){return a&&d.error("gateway sensorlist update failure",a),c(a,b)})})}],function(a,c){return a&&d.error("del sensor",a),b&&b(a,f.last(c))}):b&&b(p(403,"registration is required or not connected"))},s.upsertDevice=function(a,b,c){i.series([function(c){b.reqId||(b.reqId=a),j.post(s.gatewayUrl+"/devices",f.extend({body:b},s.requestOptions),function(e,g,h){if(e||409!==g.statusCode){if(e||2!==Math.floor(g.statusCode/100))return d.error("post Sensor failure",a,e||g.statusCode),c(e);d.debug("upsert(post) sensor",h),c()}else delete b.reqId,j.put(s.gatewayUrl+"/devices/"+a,f.extend({body:b},s.requestOptions),function(b,e,f){return b||2!==Math.floor(e.statusCode/100)?(d.error("put Device failure",a,b||e.statusCode),c(b||p(e.statusCode))):(d.debug("upsert(put) device",f),c())})})},function(b){s.getGateway(null,function(e,g){if(e)return d.error("gateway get",e),c&&b(e);var h=g.devices;h=f.pull(f.uniq(h),"null","undefined",null,void 0),f.contains(h,a)||h.push(a),s.putGateway({devices:h},function(a,c){return a&&d.error("gateway device list update failure",a),b(a,c)})})}],function(a){return a&&d.error("upsert device",a),c&&c(a)})},s.postCert=function(a,b){var f,c=a.buffer;if(a.size<=0)return f="No Cert",d.warn(f),b&&b(p(400,f));if(a.mimetype&&"application/x-pkcs12"!==a.mimetype&&"application/octet-stream"!==a.mimetype||a.headers&&a.headers["content-type"]&&"application/x-pkcs12"!==a.headers["content-type"]&&"application/octet-stream"!==a.headers["content-type"])return f="Invalid Cert",d.warn(f,a),b&&b(p(400,f));try{h.unlinkSync(e.Gateway.CERT_FILE_PATH)}catch(g){}h.writeFile(e.Gateway.CERT_FILE_PATH,c,function(a){return a?(d.error("cert create error",a),f="Invalid filename",b&&b(p(400,f))):(s.registered=!0,"https"===e.Server.service.protocol||"mqtts"===e.Server.mqtt.protocol?(f="Upload Success and Restarting app now",setTimeout(function(){m.process("restart")},2e3)):f="Upload Success",b&&b(null,f))})},s.getSensorDrivers=function(a){var b=s.baseUrl;b+="/api/sensorDrivers",d.info("[getSensorDrivers] url",b),j.get(b,f.clone(s.requestOptions),function(b,c,e){return d.debug("[getSensorDrivers] body",b,e),b?a&&a(b):2!==Math.floor(c.statusCode/100)?a&&a(p(c.statusCode)):a&&a(null,e)})},s.getGatewayModels=function(a){var b=s.baseUrl;b+="/api/gatewayModels",d.info("[getGatewayModels] url",b),j.get(b,f.clone(s.requestOptions),function(b,c,e){return d.debug("[getGatewayModels] body",b,e),b?a&&a(b):2!==Math.floor(c.statusCode/100)?a&&a(p(c.statusCode)):a&&a(null,e)})}}),c.register("./store.js",function(a,b,c){"use strict";function I(){var b,a=f.freemem()/f.totalmem()*100;k.info("Memory %s%[%s/%s] limit: %s%",a,f.freemem(),f.totalmem(),w),w&&w>a?(k.fatal("Disable storing data due to memory full(%d, %d)",a,w),H.memFull=!0):H.memFull=!1,j.check(s,function(a,b,c,d){"READY"===d&&b&&u>c/b*100?(k.warn("Filesystem full %s/%s < %s%",c,b,u),g.readdir(r,function(a,b){a||i.isEmpty(b)||(i.each(b,function(a){if(a.match(/^device_\S+\.log.+/)){try{g.unlinkSync(r+a)}catch(b){k.warn("Delete log file failure",b)}k.warn("Delete logs due to filesystem full",a)}}),j.check(t,function(a,b,c,d){"READY"===d&&b&&v>c/b*100?(k.fatal("Disable storing data due to filesystem full(%d < %d)",c/b*100,v),H.fsFull=!0):H.fsFull=!1}))})):(k.info("Filesystem %s/%s > %s%",c,b,u),H.fsFull=!1)}),b=f.uptime(),b>x&&H.getFirst(function(a,c){i.each(c.multi?c.message:[c],function(a){var d=c.multi?a:a&&a.message,e=d&&(i.isArray(d)?i.first(d):d);e&&e.b&&e.u&&(e.b!==z||e.u<1e3*(b-x))&&(k.error("Detected too old data, oldest=%j",e,a),k.error("msg.u[%d] < ((uptime - REBOOT_IN_OFFLINE_INTERVAL)[%d] *1000)",e.u,b-x),l.emit("store","tooold",a,H.size()))})}),setTimeout(I,p)}function J(){0===G.size()&&D&&(G.clean(),C=1,D=!1,setTimeout(function(){D=!0},p))}var y,z,B,C,D,E,F,G,H,d=c("mkdirp"),e=c("dirty"),f=c("os"),g=c("fs"),h=c("path"),i=c("lodash"),j=c("diskspace"),k=c("log4js").getLogger("Store"),l=c("./utils").monitor,m=c("config"),n=m.Store&&m.Store.baseDir||"/var/lib/thingplus/",o=m.Store&&m.Store.currentFile||"db.dirty",p=m.Store&&m.Store.cleanUpInterval||36e5,q="/proc/sys/kernel/random/boot_id",r=m.Gateway&&m.Gateway.logBaseDir||"/var/log/thingplus/",s=m.Gateway&&m.Gateway.logBaseDirMountPoint||"/",t=m.Gateway&&m.Gateway.storeBaseDirMountPoint||"/",u=m.Store&&m.Store.logFlushFilesystemLimit||10,v=m.Store&&m.Store.storeDisableFilesystemLimit||3,w=m.Store&&m.Store.storeDisableMemoryLimit||0,x=m.Store&&m.Store.rebootInOfflineInterval||86400;try{z=parseInt(g.readFileSync(q).slice(0,8),16).toString(36)}catch(A){}B=!1,C=0,D=!0,E={},F=!1,H=a.exports={},H.fsFull=!1,H.memFull=!1,H.isPersistent=!1,H.init=function(b){if(B)return b&&b();B=!0;try{if(!z)throw k.warn("no bootId, os=",f.platform()),z="none",Error("no bootid");d.sync(n),G=e(h.join(n,o)),H.isPersistent=!0}catch(c){k.error("use memory db instead due to persistent db failure",c),G=e(),H.isPersistent=!1}["forEach","size"].forEach(function(b){a.exports[b]=G[b].bind(G)}),G.on("error",function(a){k.error("error on loading",a)}),G.on("load",function(){return C=Number(G.getLastKey(),10)||0,C++,J(),I(),b&&b()})},H.encode=function(a){if(F){var b=!1,c={};return i.each(a.multi?a.message:[a],function(d,e){var f=a.multi?d:d&&d.message;f=f&&(i.isArray(f)?f:[f]),i.each(f,function(a){!a.t&&a.b&&a.u&&E[a.b].d&&(a.t=a.u+E[a.b].d),i.isObject(a.v)&&(b=!0)}),a.multi?(c||(c={}),c[e]=i.flatten(i.zip(i.pluck(f,"t"),i.pluck(f,"v")))):c=i.flatten(i.zip(i.pluck(f,"t"),i.pluck(f,"v")))}),{topic:a.topic,message:a.multi?JSON.stringify(c):b?JSON.stringify(c):""+c}}},H.getFirst=function(a){var b=G.getFirstKey();return b?a(b,G.get(b)):void 0},H.getLast=function(a){var b=G.getLastKey();return b?a(b,G.get(b)):void 0},H.push=y=function(a){return H.memFull||H.fsFull?void k.error("push failure due to resource limit"):(i.each(a.multi?a.message:[a],function(b){var c=a.multi?b:b&&b.message;i.each(c&&(i.isArray(c)?c:[c]),function(a){a&&a.u&&!a.b&&(a.b=z)})}),G.set(C++,a),void l.emit("store","new"))},H.rm=function(a){G.rm(a),J()},H.timeSync=function(){var b,c,d,a=[];E[z]||(d=Date.now(),c=parseInt(1e3*f.uptime(),10),E[z]={u:c,d:d-c}),G.forEach(function(b,c){i.each(c.multi?c.message:[c],function(b){var d=c.multi?b:b&&b.message,e=d&&(i.isArray(d)?i.last(d):d);E[e.b]||(E[e.b]={}),k.debug("timeSync: before",E[e.b]),e.t&&(E[e.b].d||(E[e.b].d=e.t-e.u)),E[e.b].u=e.u,a.length&&i.last(a)===e.b||a.push(e.b),k.debug("timeSync: after",E[e.b]),k.debug("timeSync: bootArr",a)})}),i.last(a)!==z&&k.info("timeSync: [%s] %s + [%s]",z,new Date(E[z].d).toISOString(),E[z].u/1e3),b=E[z],i.eachRight(a,function(a){E[a].d||(E[a].d=b.d-E[a].u),b=E[a],k.info("timeSync: [%s] %s + [%s]sec",a,new Date(E[a].d).toISOString(),E[a].u/1e3)}),F=!0}}),c.register("./utils.js",function(a,b,c){"use strict";function j(){d.EventEmitter.call(this)}function n(a,b){var c;switch(a||(a="mac"),a){case"mac":if(k)return b(null,k);i(function(a,d){return!a&&d&&(c=(""+d).replace(/[:-]/g,"").toLowerCase(),k=c),b(a,c)});break;case"mac+filesystem":if(l)return b(null,l);g("blkid -t LABEL=rootfs -s UUID -o value",{timeout:5e3,killSignal:"SIGKILL"},function(a,d){return!a&&d&&(c+=(""+d).trim(),c.replace(/-/g,""),c=parseInt(c,16).toString(36),l=c),b(a,c)});break;case"bbbserial":if(m)return b(null,m);g("hexdump -e '8/1 \"%c\"' /sys/bus/i2c/devices/0-0050/eeprom -s 16 -n 12",{timeout:5e3,killSignal:"SIGKILL"},function(a,d){return!a&&d&&(c=(""+d).trim(),m=c),b(a,c)});break;default:return b(Error("unknown type",a))}}var k,l,m,o,d=c("events"),e=c("log4js").getLogger("Utils"),f=c("util"),g=c("child_process").exec,h=c("async"),i=c("getmac").getMac;f.inherits(j,d.EventEmitter),a.exports.monitor=new j,a.exports.statusError=function(a,b){var c=Error(b?a+" "+b:""+a);return c.statusCode=a,c},a.exports.isValidTime=function(a){return a||(a=Date.now()),a>1388502e6},a.exports.getId=n,a.exports.getBoardInfo=function(a){if(o)return a(null,o);o={};var b=setTimeout(function(){return e.error("[getBoardInfo] blocked",o),b=null,a&&a(null,o)},1e3);h.series([function(a){n("mac",function(b,c){return!b&&c&&(o={macaddress:c}),a()})},function(a){g("hexdump -e '8/1 \"%c\"' /sys/bus/i2c/devices/0-0050/eeprom -s 4 -n 24",{timeout:5e3,killSignal:"SIGKILL"},function(b,c){if(!b&&c){var d=(""+c).trim();o.model=d.substring(0,8),o.rev=d.substring(8,12),o.serial=d.substring(12,24)}return a()})},function(a){return!o.model&&process.env.MODEL&&(o.model=process.env.MODEL),!o.serial&&process.env.SN&&(o.serial=process.env.SN),a()}],function(c){return b?(clearTimeout(b),b=null,a&&a(c,o)):void e.error("[getBoardInfo] timeout",o)})}}),b.exports=c("./app.js")}(require,module);
